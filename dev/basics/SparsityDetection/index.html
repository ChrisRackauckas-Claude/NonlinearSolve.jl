<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>(Semi-)Automatic Sparsity Detection · NonlinearSolve.jl</title><meta name="title" content="(Semi-)Automatic Sparsity Detection · NonlinearSolve.jl"/><meta property="og:title" content="(Semi-)Automatic Sparsity Detection · NonlinearSolve.jl"/><meta property="twitter:title" content="(Semi-)Automatic Sparsity Detection · NonlinearSolve.jl"/><meta name="description" content="Documentation for NonlinearSolve.jl."/><meta property="og:description" content="Documentation for NonlinearSolve.jl."/><meta property="twitter:description" content="Documentation for NonlinearSolve.jl."/><meta property="og:url" content="https://docs.sciml.ai/NonlinearSolve/stable/basics/SparsityDetection/"/><meta property="twitter:url" content="https://docs.sciml.ai/NonlinearSolve/stable/basics/SparsityDetection/"/><link rel="canonical" href="https://docs.sciml.ai/NonlinearSolve/stable/basics/SparsityDetection/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="NonlinearSolve.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">NonlinearSolve.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">NonlinearSolve.jl: High-Performance Unified Nonlinear Solvers</a></li><li><a class="tocitem" href="../../tutorials/getting_started/">Getting Started with Nonlinear Rootfinding in Julia</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/code_optimization/">Code Optimization for Small Nonlinear Systems in Julia</a></li><li><a class="tocitem" href="../../tutorials/large_systems/">Efficiently Solving Large Sparse Ill-Conditioned Nonlinear Systems in Julia</a></li><li><a class="tocitem" href="../../tutorials/modelingtoolkit/">Symbolic Nonlinear System Definition and Acceleration via ModelingToolkit</a></li><li><a class="tocitem" href="../../tutorials/small_compile/">Faster Startup and and Static Compilation</a></li><li><a class="tocitem" href="../../tutorials/iterator_interface/">Nonlinear Solver Iterator Interface</a></li><li><a class="tocitem" href="../../tutorials/optimizing_parameterized_ode/">Optimizing a Parameterized ODE</a></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../NonlinearProblem/">Nonlinear Problems</a></li><li><a class="tocitem" href="../NonlinearFunctions/">NonlinearFunctions and Jacobian Types</a></li><li><a class="tocitem" href="../solve/">Common Solver Options (Solve Keyword Arguments)</a></li><li><a class="tocitem" href="../NonlinearSolution/">Nonlinear Solutions</a></li><li><a class="tocitem" href="../TerminationCondition/">Termination Conditions</a></li><li><a class="tocitem" href="../Logging/">Logging the Solve Process</a></li><li class="is-active"><a class="tocitem" href>(Semi-)Automatic Sparsity Detection</a><ul class="internal"><li><a class="tocitem" href="#Case-I:-Sparse-Jacobian-Prototype-is-Provided"><span>Case I: Sparse Jacobian Prototype is Provided</span></a></li><li><a class="tocitem" href="#Case-II:-Sparsity-Detection-algorithm-is-provided"><span>Case II: Sparsity Detection algorithm is provided</span></a></li><li><a class="tocitem" href="#Case-III:-Sparse-AD-Type-is-being-Used"><span>Case III: Sparse AD Type is being Used</span></a></li></ul></li><li><a class="tocitem" href="../FAQ/">Frequently Asked Questions</a></li></ul></li><li><span class="tocitem">Solver Summaries and Recommendations</span><ul><li><a class="tocitem" href="../../solvers/NonlinearSystemSolvers/">Nonlinear System Solvers</a></li><li><a class="tocitem" href="../../solvers/BracketingSolvers/">Interval Rootfinding Methods (Bracketing Solvers)</a></li><li><a class="tocitem" href="../../solvers/SteadyStateSolvers/">Steady State Solvers</a></li><li><a class="tocitem" href="../../solvers/NonlinearLeastSquaresSolvers/">Nonlinear Least Squares Solvers</a></li><li><a class="tocitem" href="../../solvers/LineSearch/">Line Search</a></li></ul></li><li><span class="tocitem">Detailed Solver APIs</span><ul><li><a class="tocitem" href="../../api/nonlinearsolve/">NonlinearSolve.jl Native Solvers</a></li><li><a class="tocitem" href="../../api/simplenonlinearsolve/">SimpleNonlinearSolve.jl</a></li><li><a class="tocitem" href="../../api/minpack/">MINPACK.jl</a></li><li><a class="tocitem" href="../../api/nlsolve/">NLsolve.jl</a></li><li><a class="tocitem" href="../../api/sundials/">Sundials.jl</a></li><li><a class="tocitem" href="../../api/steadystatediffeq/">SteadyStateDiffEq.jl</a></li><li><a class="tocitem" href="../../api/leastsquaresoptim/">LeastSquaresOptim.jl</a></li><li><a class="tocitem" href="../../api/fastlevenbergmarquardt/">FastLevenbergMarquardt.jl</a></li></ul></li><li><a class="tocitem" href="../../release_notes/">Release Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>(Semi-)Automatic Sparsity Detection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>(Semi-)Automatic Sparsity Detection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/NonlinearSolve.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/NonlinearSolve.jl/blob/master/docs/src/basics/SparsityDetection.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="sparsity-detection"><a class="docs-heading-anchor" href="#sparsity-detection">(Semi-)Automatic Sparsity Detection</a><a id="sparsity-detection-1"></a><a class="docs-heading-anchor-permalink" href="#sparsity-detection" title="Permalink"></a></h1><p>This section describes how to enable Sparsity Detection. For a detailed tutorial on how to use this in an actual problem, see <a href="../../tutorials/large_systems/#large_systems">this tutorial on Efficiently Solving Large Sparse Ill-Conditioned Nonlinear Systems</a>.</p><p>Notation wise we are trying to solve for <code>x</code> such that <code>nlfunc(x) = 0</code>.</p><h2 id="Case-I:-Sparse-Jacobian-Prototype-is-Provided"><a class="docs-heading-anchor" href="#Case-I:-Sparse-Jacobian-Prototype-is-Provided">Case I: Sparse Jacobian Prototype is Provided</a><a id="Case-I:-Sparse-Jacobian-Prototype-is-Provided-1"></a><a class="docs-heading-anchor-permalink" href="#Case-I:-Sparse-Jacobian-Prototype-is-Provided" title="Permalink"></a></h2><p>Let&#39;s say you have a Sparse Jacobian Prototype <code>jac_prototype</code>, in this case you can create your problem as follows:</p><pre><code class="language-julia hljs">prob = NonlinearProblem(NonlinearFunction(nlfunc; sparsity = jac_prototype), x0)
# OR
prob = NonlinearProblem(NonlinearFunction(nlfunc; jac_prototype = jac_prototype), x0)</code></pre><p>NonlinearSolve will automatically perform matrix coloring and use sparse differentiation.</p><p>Now you can help the solver further by providing the color vector. This can be done by</p><pre><code class="language-julia hljs">prob = NonlinearProblem(NonlinearFunction(nlfunc; sparsity = jac_prototype,
        colorvec = colorvec), x0)
# OR
prob = NonlinearProblem(NonlinearFunction(nlfunc; jac_prototype = jac_prototype,
        colorvec = colorvec), x0)</code></pre><p>If the <code>colorvec</code> is not provided, then it is computed on demand.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>One thing to be careful about in this case is that <code>colorvec</code> is dependent on the autodiff backend used. Forward Mode and Finite Differencing will assume that the colorvec is the column colorvec, while Reverse Mode will assume that the colorvec is the row colorvec.</p></div></div><h2 id="Case-II:-Sparsity-Detection-algorithm-is-provided"><a class="docs-heading-anchor" href="#Case-II:-Sparsity-Detection-algorithm-is-provided">Case II: Sparsity Detection algorithm is provided</a><a id="Case-II:-Sparsity-Detection-algorithm-is-provided-1"></a><a class="docs-heading-anchor-permalink" href="#Case-II:-Sparsity-Detection-algorithm-is-provided" title="Permalink"></a></h2><p>If you don&#39;t have a Sparse Jacobian Prototype, but you know the which sparsity detection algorithm you want to use, then you can create your problem as follows:</p><pre><code class="language-julia hljs">prob = NonlinearProblem(NonlinearFunction(nlfunc; sparsity = SymbolicsSparsityDetection()),
    x0)  # Remember to have Symbolics.jl loaded
# OR
prob = NonlinearProblem(NonlinearFunction(nlfunc; sparsity = ApproximateJacobianSparsity()),
    x0)</code></pre><p>These Detection Algorithms are from <a href="https://github.com/JuliaDiff/SparseDiffTools.jl">SparseDiffTools.jl</a>, refer to the documentation there for more details.</p><h2 id="Case-III:-Sparse-AD-Type-is-being-Used"><a class="docs-heading-anchor" href="#Case-III:-Sparse-AD-Type-is-being-Used">Case III: Sparse AD Type is being Used</a><a id="Case-III:-Sparse-AD-Type-is-being-Used-1"></a><a class="docs-heading-anchor-permalink" href="#Case-III:-Sparse-AD-Type-is-being-Used" title="Permalink"></a></h2><p>If you constructed a Nonlinear Solver with a sparse AD type, for example</p><pre><code class="language-julia hljs">NewtonRaphson(; autodiff = AutoSparseForwardDiff())
# OR
TrustRegion(; autodiff = AutoSparseZygote())</code></pre><p>then NonlinearSolve will automatically perform matrix coloring and use sparse differentiation if none of <code>sparsity</code> or <code>jac_prototype</code> is provided. If <code>Symbolics.jl</code> is loaded, we default to using <code>SymbolicsSparsityDetection()</code>, else we default to using <code>ApproximateJacobianSparsity()</code>.</p><p><code>Case I/II</code> take precedence for sparsity detection and we perform sparse AD based on those options if those are provided.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>If you provide a non-sparse AD, and provide a <code>sparsity</code> or <code>jac_prototype</code> then we will use dense AD. This is because, if you provide a specific AD type, we assume that you know what you are doing and want to override the default choice of <code>nothing</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Logging/">« Logging the Solve Process</a><a class="docs-footer-nextpage" href="../FAQ/">Frequently Asked Questions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Sunday 17 December 2023 20:39">Sunday 17 December 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
